name: Generate downloads repository

on:
  push:
    branch: main

jobs:
  pages-release:
    name: Main ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          #- arch: arc_archs
          #  target: archs38-generic
          #  runtime_test: false
          #
          #- arch: arm_cortex-a9_vfpv3-d16
          #  target: mvebu-cortexa9
          #  runtime_test: false

          #- arch: mips_24kc
          #  target: ath79-generic
          #  runtime_test: false

          - arch: mipsel_24kc
            target: mt7621
            runtime_test: false
          #
          #- arch: powerpc_464fp
          #  target: apm821xx-nand
          #  runtime_test: false
          #
          #- arch: powerpc_8540
          #  target: mpc85xx-p1010
          #  runtime_test: false
          #
          #- arch: aarch64_cortex-a53
          #  target: mvebu-cortexa53
          #  runtime_test: true
          #
          #- arch: arm_cortex-a15_neon-vfpv4
          #  target: armvirt-32
          #  runtime_test: true
          #
          #- arch: i386_pentium-mmx
          #  target: x86-geode
          #  runtime_test: true
          #
          #- arch: x86_64
          #  target: x86-64
          #  runtime_test: true
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Determine changed packages
        run: |
          PKG_ROOTS=$(find . -name Makefile | \
            grep -v ".*/src/Makefile" | \
            sed -e 's@./\(.*\)/Makefile@\1/@')

          for ROOT in $PKG_ROOTS; do
            PACKAGES+=$(echo "$ROOT" | sed -e 's@.*/\(.*\)/@\1 @')
            break
          done

          # fallback to test packages if nothing explicitly changes this is
          # should run if other mechanics in packages.git changed
          PACKAGES="${PACKAGES:-vim attendedsysupgrade-common bmon}"

          echo "Building $PACKAGES"
          echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV
      - name: Compile packages in the feed
        uses: rafaelcalleja/gh-action-sdk@0.0.1
        env:
          ARCH: ${{ matrix.arch }}-master
          FEEDNAME: packages_ci
          NO_DEFAULT_FEEDS: true
          NO_REFRESH_CHECK: true
          NO_SHFMT_CHECK: true
          PACKAGES: ${{ env.$PACKAGES }}
          V: s

      - name: Store targets
        uses: actions/upload-artifact@v3
        with:
          name: ${{env.ARCHIVE_NAME}}-targets
          path: targets/

      - uses: actions/download-artifact@v3
        with:
          name: ${{env.ARCHIVE_NAME}}-targets
          path: targets/
      - name: Deploy created packages to gh-pages
        run: |
          git checkout gh-pages 
          mkdir -p resources/18.06.2/targets -p
          find targets/ || true
          find /artifacts/ || true          
          mv bin/targets/* resources/18.06.2/targets
          git config user.name  github-actions
          git config user.email github-actions@github.com
          git add resources
          (git commit -m "bump packages" && git push) || true        
